#!/bin/sh

#  !---------------------------------------------------------------------!
#  ! Written by Madu Manathunga on 07/19/2020                            !
#  !                                                                     !
#  ! Copyright (C) 2020-2021 Merz lab                                    !
#  ! Copyright (C) 2020-2021 GÃ¶tz lab                                    !
#  !                                                                     !
#  ! This Source Code Form is subject to the terms of the Mozilla Public !
#  ! License, v. 2.0. If a copy of the MPL was not distributed with this !
#  ! file, You can obtain one at http://mozilla.org/MPL/2.0/.            !
#  !_____________________________________________________________________!
#
#  !---------------------------------------------------------------------!
#  ! This source code runs a series test cases saved in test folder and  !
#  ! verifies the correctness of a QUICK installation.                   !
#  ! ** Must be executed from QUICK_HOME or installation directories.    !
#  !---------------------------------------------------------------------!

#  !---------------------------------------------------------------------!
#  ! QUICK version                                                       !
#  !---------------------------------------------------------------------!

QUICK_VERSION='QUICK-24.03'

#  !---------------------------------------------------------------------!
#  ! Variable definitions                                                !
#  !---------------------------------------------------------------------!

# directories
installdir=`pwd`
testdir="$installdir/test"
qbasisdir="$installdir/basis"
qbindir="$installdir/bin"
export QUICK_HOME=$installdir

# executables
qexe=''
buildtypes=''
serial='no'
mpi='no'
cuda='no'
cudampi='no'
hip='no'
hipmpi='no'
apiexe=''

# test list file
test_list=''

# flag to indicate if mpirun is available
ismpirun='no'

# number of cores for mpi tests
ncores=2

# flag for a mp2 calculation
ismp2=''

# current date time variable
cdate=''
ctime=''

# test types
test_ene='no'
test_grad='no'
test_opt='no'
test_api='no'
uspec_test='no'
test_length='short'

# verbosity
log='yes'

# variable to keep track of total failed tests
ncum_failed_tests=0

# path to api executables
apipath=''

#  !---------------------------------------------------------------------!
#  ! Function definitions                                                !
#  !---------------------------------------------------------------------!

# this function prints help page
print_help(){

echo  "                                                                                                                                       
  Use this script as ./runtest [flags]                            
                                                                            
  Available flags are:                                                      
      --serial       Tests QUICK serial version                                
      --mpi          Tests QUICK MPI parallel version                           
      --cuda         Tests QUICK GPU version
      --cudampi      Tests QUICK multi-GPU version
      --hip          Tests QUICK AMD GPU version
      --hipmpi       Tests QUICK AMD multi-GPU version
      --ene          Run only energy tests
      --grad         Run only gradient tests
      --opt          Run only geometry optimization tests
      --api          Run only api tests
      --full         Run a large set of tests (Default: no)
      --nolog        Disable writing output into runtest.log (Default: no)
                                                                            
  If the version flags are not specified, the script will try to detect
  the executables and test them.
  
  "

exit 0;

}


print_test_info(){

  ismp2='no'
  testinfo=""
  case "$t" in
    ene_AlH3_rhf_sto3g)                   testinfo="ALH3: RHF energy test: STO-3G basis set";;
    ene_BeH2_rhf_sto3g)                   testinfo="BeH2: RHF energy test: STO-3G basis set";;
    ene_BH3_rhf_sto3g)                    testinfo="BH3: RHF energy test: STO-3G basis set";;
    ene_CaCl2_rhf_sto3g)                  testinfo="CaCl2: RHF energy test: STO-3G basis set";;
    ene_CH4_rhf_sto3g)                    testinfo="CH4: RHF energy test: STO-3G basis set";;
    ene_H2O_rhf_sto3g)                    testinfo="H2O: RHF energy test: STO-3G basis set";;
    ene_HBr_rhf_sto3g)                    testinfo="HBr: RHF energy test: STO-3G basis set";;
    ene_HI_rhf_sto3g)                     testinfo="HI: RHF energy test: STO-3G basis set";;
    ene_KCl_rhf_sto3g)                    testinfo="KCl: RHF energy test: STO-3G basis set";;
    ene_LiF_rhf_sto3g)                    testinfo="LiF: RHF energy test: STO-3G basis set";;
    ene_MgO_rhf_sto3g)                    testinfo="MgO: RHF energy test: STO-3G basis set";;
    ene_NaCl_rhf_sto3g)                   testinfo="NaCl: RHF energy test: STO-3G basis set";;
    ene_NH4_rhf_sto3g)                    testinfo="NH4: RHF energy test: STO-3G basis set";;
    ene_PO4_3_rhf_sto3g)                  testinfo="PO4-3: RHF energy test: STO-3G basis set";;
    ene_SiH4_rhf_sto3g)                   testinfo="SiH4: RHF energy test: STO-3G basis set";;
    ene_SO2_rhf_sto3g)                    testinfo="SO2: RHF energy test: STO-3G basis set";;
    ene_AlH3_rhf_321g)                    testinfo="ALH3: RHF energy test: 3-21G basis set";;
    ene_BeH2_rhf_321g)                    testinfo="BeH2: RHF energy test: 3-21G basis set";;
    ene_BH3_rhf_321g)                     testinfo="BH3: RHF energy test: 3-21G basis set";;
    ene_CaCl2_rhf_321g)                   testinfo="CaCl2: RHF energy test: 3-21G basis set";;
    ene_CH4_rhf_321g)                     testinfo="CH4: RHF energy test: 3-21G basis set";;
    ene_H2O_rhf_321g)                     testinfo="H2O: RHF energy test: 3-21G basis set";;
    ene_HBr_rhf_321g)                     testinfo="HBr: RHF energy test: 3-21G basis set";;
    ene_HI_rhf_321g)                      testinfo="HI: RHF energy test: 3-21G basis set";;
    ene_KCl_rhf_321g)                     testinfo="KCl: RHF energy test: 3-21G basis set";;
    ene_LiF_rhf_321g)                     testinfo="LiF: RHF energy test: 3-21G basis set";;
    ene_MgO_rhf_321g)                     testinfo="MgO: RHF energy test: 3-21G basis set";;
    ene_NaCl_rhf_321g)                    testinfo="NaCl: RHF energy test: 3-21G basis set";;
    ene_NH4_rhf_321g)                     testinfo="NH4: RHF energy test: 3-21G basis set";;
    ene_PO4_3_rhf_321g)                   testinfo="PO4-3: RHF energy test: 3-21G basis set";;
    ene_SiH4_rhf_321g)                    testinfo="SiH4: RHF energy test: 3-21G basis set";;
    ene_SO2_rhf_321g)                     testinfo="SO2: RHF energy test: 3-21G basis set";;
    ene_AlH3_rhf_631g)                    testinfo="ALH3: RHF energy test: 6-31G basis set";;
    ene_BeH2_rhf_631g)                    testinfo="BeH2: RHF energy test: 6-31G basis set";;
    ene_BH3_rhf_631g)                     testinfo="BH3: RHF energy test: 6-31G basis set";;
    ene_CaCl2_rhf_631g)                   testinfo="CaCl2: RHF energy test: 6-31G basis set";;            # currently disabled
    ene_CH4_rhf_631g)                     testinfo="CH4: RHF energy test: 6-31G basis set";;
    ene_H2O_rhf_631g)                     testinfo="H2O: RHF energy test: 6-31G basis set";;
    ene_HBr_rhf_631g)                     testinfo="HBr: RHF energy test: 6-31G basis set";;              # currently disabled
    ene_KCl_rhf_631g)                     testinfo="KCl: RHF energy test: 6-31G basis set";;              # currently disabled
    ene_LiF_rhf_631g)                     testinfo="LiF: RHF energy test: 6-31G basis set";;
    ene_MgO_rhf_631g)                     testinfo="MgO: RHF energy test: 6-31G basis set";;
    ene_NaCl_rhf_631g)                    testinfo="NaCl: RHF energy test: 6-31G basis set";;
    ene_NH4_rhf_631g)                     testinfo="NH4: RHF energy test: 6-31G basis set";;
    ene_PO4_3_rhf_631g)                   testinfo="PO4-3: RHF energy test: 6-31G basis set";;
    ene_SiH4_rhf_631g)                    testinfo="SiH4: RHF energy test: 6-31G basis set";;
    ene_SO2_rhf_631g)                     testinfo="SO2: RHF energy test: 6-31G basis set";;
    ene_AlH3_rhf_631gs)                   testinfo="ALH3: RHF energy test: 6-31G* basis set";;
    ene_BeH2_rhf_631gs)                   testinfo="BeH2: RHF energy test: 6-31G* basis set";;
    ene_BH3_rhf_631gs)                    testinfo="BH3: RHF energy test: 6-31G* basis set";;
    ene_CaCl2_rhf_631gs)                  testinfo="CaCl2: RHF energy test: 6-31G* basis set";;           # currently disabled
    ene_CH4_rhf_631gs)                    testinfo="CH4: RHF energy test: 6-31G* basis set";;
    ene_H2O_rhf_631gs)                    testinfo="H2O: RHF energy test: 6-31G* basis set";;
    ene_HBr_rhf_631gs)                    testinfo="HBr: RHF energy test: 6-31G* basis set";;             # currently disabled
    ene_KCl_rhf_631gs)                    testinfo="KCl: RHF energy test: 6-31G* basis set";;             # currently disabled
    ene_LiF_rhf_631gs)                    testinfo="LiF: RHF energy test: 6-31G* basis set";;
    ene_MgO_rhf_631gs)                    testinfo="MgO: RHF energy test: 6-31G* basis set";;
    ene_NaCl_rhf_631gs)                   testinfo="NaCl: RHF energy test: 6-31G* basis set";;
    ene_NH4_rhf_631gs)                    testinfo="NH4: RHF energy test: 6-31G* basis set";;
    ene_PO4_3_rhf_631gs)                  testinfo="PO4-3: RHF energy test: 6-31G* basis set";;
    ene_SiH4_rhf_631gs)                   testinfo="SiH4: RHF energy test: 6-31G* basis set";;
    ene_SO2_rhf_631gs)                    testinfo="SO2: RHF energy test: 6-31G* basis set";;
    ene_AlH3_rhf_631gss)                  testinfo="ALH3: RHF energy test: 6-31G** basis set";;
    ene_BeH2_rhf_631gss)                  testinfo="BeH2: RHF energy test: 6-31G** basis set";;
    ene_BH3_rhf_631gss)                   testinfo="BH3: RHF energy test: 6-31G** basis set";;
    ene_CaCl2_rhf_631gss)                 testinfo="CaCl2: RHF energy test: 6-31G** basis set";;          # currently disabled
    ene_CH4_rhf_631gss)                   testinfo="CH4: RHF energy test: 6-31G** basis set";;
    ene_H2O_rhf_631gss)                   testinfo="H2O: RHF energy test: 6-31G** basis set";;
    ene_HBr_rhf_631gss)                   testinfo="HBr: RHF energy test: 6-31G** basis set";;            # currently disabled
    ene_KCl_rhf_631gss)                   testinfo="KCl: RHF energy test: 6-31G** basis set";;            # currently disabled
    ene_LiF_rhf_631gss)                   testinfo="LiF: RHF energy test: 6-31G** basis set";;
    ene_MgO_rhf_631gss)                   testinfo="MgO: RHF energy test: 6-31G** basis set";;
    ene_NaCl_rhf_631gss)                  testinfo="NaCl: RHF energy test: 6-31G** basis set";;
    ene_NH4_rhf_631gss)                   testinfo="NH4: RHF energy test: 6-31G** basis set";;
    ene_PO4_3_rhf_631gss)                 testinfo="PO4-3: RHF energy test: 6-31G** basis set";;
    ene_SiH4_rhf_631gss)                  testinfo="SiH4: RHF energy test: 6-31G** basis set";;
    ene_SO2_rhf_631gss)                   testinfo="SO2: RHF energy test: 6-31G** basis set";;
    ene_AlH3_rhf_ccpvdz)                  testinfo="ALH3: RHF energy test: cc-pVDZ basis set";;           # currently disabled
    ene_BeH2_rhf_ccpvdz)                  testinfo="BeH2: RHF energy test: cc-pVDZ basis set";;
    ene_BH3_rhf_ccpvdz)                   testinfo="BH3: RHF energy test: cc-pVDZ basis set";;
    ene_CaCl2_rhf_ccpvdz)                 testinfo="CaCl2: RHF energy test: cc-pVDZ basis set";;          # currently disabled
    ene_CH4_rhf_ccpvdz)                   testinfo="CH4: RHF energy test: cc-pVDZ basis set";;
    ene_H2O_rhf_ccpvdz)                   testinfo="H2O: RHF energy test: cc-pVDZ basis set";;
    ene_HBr_rhf_ccpvdz)                   testinfo="HBr: RHF energy test: cc-pVDZ basis set";;            # currently disabled
    ene_KCl_rhf_ccpvdz)                   testinfo="KCl: RHF energy test: cc-pVDZ basis set";;            # currently disabled
    ene_LiF_rhf_ccpvdz)                   testinfo="LiF: RHF energy test: cc-pVDZ basis set";;
    ene_MgO_rhf_ccpvdz)                   testinfo="MgO: RHF energy test: cc-pVDZ basis set";;            # currently disabled
    ene_NaCl_rhf_ccpvdz)                  testinfo="NaCl: RHF energy test: cc-pVDZ basis set";;           # currently disabled
    ene_NH4_rhf_ccpvdz)                   testinfo="NH4: RHF energy test: cc-pVDZ basis set";;
    ene_PH3_rhf_ccpvdz)                   testinfo="PH3: RHF energy test: cc-pVDZ basis set";;            # currently disabled
    ene_SiH4_rhf_ccpvdz)                  testinfo="SiH4: RHF energy test: cc-pVDZ basis set";;           # currently disabled
    ene_SO2_rhf_ccpvdz)                   testinfo="SO2: RHF energy test: cc-pVDZ basis set";;            # currently disabled
    grad_AlH3_b3lyp_def2sv_p)             testinfo="ALH3: DFT gradient test: DEF2-SV(P) basis set";;
    grad_BeH2_b3lyp_def2sv_p)             testinfo="BeH2: DFT gradient test: DEF2-SV(P) basis set";;
    grad_BH3_b3lyp_def2sv_p)              testinfo="BH3: DFT gradient test: DEF2-SV(P) basis set";;       # currently disabled
    grad_CaCl2_b3lyp_def2sv_p)            testinfo="CaCl2: DFT gradient test: DEF2-SV(P) basis set";;     # currently disabled
    grad_CH4_b3lyp_def2sv_p)              testinfo="CH4: DFT gradient test: DEF2-SV(P) basis set";;       
    grad_H2O_b3lyp_def2sv_p)              testinfo="H2O: DFT gradient test: DEF2-SV(P) basis set";;       
    grad_HBr_b3lyp_def2sv_p)              testinfo="HBr: DFT gradient test: DEF2-SV(P) basis set";;       
    grad_HI_b3lyp_def2sv_p)               testinfo="HI: DFT gradient test: DEF2-SV(P) basis set";;        # currently disabled
    grad_KCl_b3lyp_def2sv_p)              testinfo="KCl: DFT gradient test: DEF2-SV(P) basis set";;       
    grad_LiF_b3lyp_def2sv_p)              testinfo="LiF: DFT gradient test: DEF2-SV(P) basis set";;       
    grad_MgO_b3lyp_def2sv_p)              testinfo="MgO: DFT gradient test: DEF2-SV(P) basis set";;       
    grad_NaCl_b3lyp_def2sv_p)             testinfo="NaCl: DFT gradient test: DEF2-SV(P) basis set";;      
    grad_NH4_b3lyp_def2sv_p)              testinfo="NH4: DFT gradient test: DEF2-SV(P) basis set";;       
    grad_PH3_b3lyp_def2sv_p)              testinfo="PH3: DFT gradient test: DEF2-SV(P) basis set";;       
    grad_SiH4_b3lyp_def2sv_p)             testinfo="SiH4: DFT gradient test: DEF2-SV(P) basis set";;      
    grad_SO2_b3lyp_def2sv_p)              testinfo="SO2: DFT gradient test: DEF2-SV(P) basis set";;       
    grad_AlH3_b3lyp_def2svp)              testinfo="ALH3: DFT gradient test: DEF2-SVP basis set";;        
    grad_BeH2_b3lyp_def2svp)              testinfo="BeH2: DFT gradient test: DEF2-SVP basis set";;        
    grad_BH3_b3lyp_def2svp)               testinfo="BH3: DFT gradient test: DEF2-SVP basis set";;         
    grad_CaCl2_b3lyp_def2svp)             testinfo="CaCl2: DFT gradient test: DEF2-SVP basis set";;       # currently disabled
    grad_CH4_b3lyp_def2svp)               testinfo="CH4: DFT gradient test: DEF2-SVP basis set";;         
    grad_H2O_b3lyp_def2svp)               testinfo="H2O: DFT gradient test: DEF2-SVP basis set";;         
    grad_HBr_b3lyp_def2svp)               testinfo="HBr: DFT gradient test: DEF2-SVP basis set";;         
    grad_HI_b3lyp_def2svp)                testinfo="HI: DFT gradient test: DEF2-SVP basis set";;          # currently disabled
    grad_KCl_b3lyp_def2svp)               testinfo="KCl: DFT gradient test: DEF2-SVP basis set";;
    grad_LiF_b3lyp_def2svp)               testinfo="LiF: DFT gradient test: DEF2-SVP basis set";;
    grad_MgO_b3lyp_def2svp)               testinfo="MgO: DFT gradient test: DEF2-SVP basis set";;
    grad_NaCl_b3lyp_def2svp)              testinfo="NaCl: DFT gradient test: DEF2-SVP basis set";;
    grad_NH4_b3lyp_def2svp)               testinfo="NH4: DFT gradient test: DEF2-SVP basis set";;
    grad_PH3_b3lyp_def2svp)               testinfo="PH3: DFT gradient test: DEF2-SVP basis set";;
    grad_SiH4_b3lyp_def2svp)              testinfo="SiH4: DFT gradient test: DEF2-SVP basis set";;
    grad_SO2_b3lyp_def2svp)               testinfo="SO2: DFT gradient test: DEF2-SVP basis set";;
    grad_AlH3_b3lyp_def2svpd)             testinfo="ALH3: DFT gradient test: DEF2-SVPD basis set";;
    grad_BeH2_b3lyp_def2svpd)             testinfo="BeH2: DFT gradient test: DEF2-SVPD basis set";;
    grad_BH3_b3lyp_def2svpd)              testinfo="BH3: DFT gradient test: DEF2-SVPD basis set";;        # currently disabled
    grad_CaCl2_b3lyp_def2svpd)            testinfo="CaCl2: DFT gradient test: DEF2-SVPD basis set";;      # currently disabled
    grad_CH4_b3lyp_def2svpd)              testinfo="CH4: DFT gradient test: DEF2-SVPD basis set";;        
    grad_H2O_b3lyp_def2svpd)              testinfo="H2O: DFT gradient test: DEF2-SVPD basis set";;        
    grad_HBr_b3lyp_def2svpd)              testinfo="HBr: DFT gradient test: DEF2-SVPD basis set";;        # currently disabled
    grad_HI_b3lyp_def2svpd)               testinfo="HI: DFT gradient test: DEF2-SVPD basis set";;         # currently disabled
    grad_KCl_b3lyp_def2svpd)              testinfo="KCl: DFT gradient test: DEF2-SVPD basis set";;
    grad_LiF_b3lyp_def2svpd)              testinfo="LiF: DFT gradient test: DEF2-SVPD basis set";;
    grad_MgO_b3lyp_def2svpd)              testinfo="MgO: DFT gradient test: DEF2-SVPD basis set";;
    grad_NaCl_b3lyp_def2svpd)             testinfo="NaCl: DFT gradient test: DEF2-SVPD basis set";;
    grad_NH4_b3lyp_def2svpd)              testinfo="NH4: DFT gradient test: DEF2-SVPD basis set";;
    grad_PH3_b3lyp_def2svpd)              testinfo="PH3: DFT gradient test: DEF2-SVPD basis set";;
    grad_SiH4_b3lyp_def2svpd)             testinfo="SiH4: DFT gradient test: DEF2-SVPD basis set";;
    grad_SO2_b3lyp_def2svpd)              testinfo="SO2: DFT gradient test: DEF2-SVPD basis set";;
    ene_psb5_rhf_631g)                    testinfo="PSB5: RHF energy test: s and p basis functions";;
    ene_psb5_rhf_631gss)                  testinfo="PSB5: RHF energy test: s, p and d basis functions";;
    ene_acetone_rhf_321g)                 testinfo="Acetone: RHF energy test: s and p basis functions";;
    ene_psb3_blyp_631g)                   testinfo="PSB3: DFT energy test: s and p basis functions, BLYP functional";;
    ene_psb3_blyp_631gss)                 testinfo="PSB3: DFT energy test: s, p and d basis functions, BLYP functional";;
    ene_psb3_b3lyp_631g)                  testinfo="PSB3: DFT energy test: s and p basis functions, native B3LYP functional";;
    ene_psb3_b3lyp_631gss)                testinfo="PSB3: DFT energy test: s, p and d basis functions, native B3LYP functional";;
    ene_C2H6_b3lyp_def2tzvp)              testinfo="C2H6: DFT energy test: s, p, d and f basis functions, native B3LYP functional";;
    ene_psb3_libxc_lda_631g)              testinfo="PSB3: DFT energy test: s and p basis functions, libxc LDA functional";;
    ene_psb3_libxc_gga_631g)              testinfo="PSB3: DFT energy test: s and p basis functions, libxc GGA functional";;
    ene_psb3_libxc_hgga_631g)             testinfo="PSB3: DFT energy test: s and p basis functions, libxc hybrid GGA functional";;
    ene_wat2_mp2_631g)                    testinfo="Water-2 MP2 energy test: s and p basis functions"; ismp2='yes';;
    ene_wat2_mp2_631gss)                  testinfo="Water-2 MP2 energy test: s, p and d basis functions"; ismp2='yes';;
    grad_psb3_b3lyp_631g)                 testinfo="PSB3: DFT gradient test: s and p basis functions";;
    grad_psb3_b3lyp_631gss)               testinfo="PSB3: DFT gradient test: s and p and d basis functions";;
    grad_psb3_b3lyp_d3bj_def2svp)         testinfo="PSB3: DFT gradient test: s and p basis functions, DFT-D3 dispersion correction";; 
    grad_ch3conhch3_b3lyp_ccpvdz)         testinfo="CH3CONHCH3: DFT gradient test: s and p and d basis functions";;
    grad_CH4_pbe0_6311g2df2pd)            testinfo="CH4: DFT gradient test: s, p, d and f basis functions";;
    grad_ch5nos_b3lyp_6311g)              testinfo="CH5NOS: B3LYP gradient test with 6-311G basis set";;
    grad_ch5nos_b3lyp_6311gd)             testinfo="CH5NOS: B3LYP gradient test with 6-311G(d) basis set";;
    grad_ch5nos_b3lyp_6311gdp)            testinfo="CH5NOS: B3LYP gradient test with 6-311G(d,p) basis set";;
    grad_ch5nos_b3lyp_631plgdp)           testinfo="CH5NOS: B3LYP gradient test with 6-31+G(d,p) basis set";;
    grad_ch5nos_b3lyp_631plplgdp)         testinfo="CH5NOS: B3LYP gradient test with 6-31++G(d,p) basis set";;
    grad_ch5nos_b3lyp_6311plg2dp)         testinfo="CH5NOS: B3LYP gradient test with 6-311+G(2d,p) basis set";;
    grad_ch5nos_b3lyp_6311plplg2d2p)      testinfo="CH5NOS: B3LYP gradient test with 6-311++G(2d,2p) basis set";;
    grad_ch5nos_b3lyp_pc0)                testinfo="CH5NOS: B3LYP gradient test with PC-0 basis set";; 
    grad_ch5nos_b3lyp_pc1)                testinfo="CH5NOS: B3LYP gradient test with PC-1 basis set";;
    grad_ch5nos_b97_631g)                 testinfo="CH5NOS: DFT gradient test: s and p basis functions, B97 functional";;
    grad_ch5nos_b97-gga1_631g)            testinfo="CH5NOS: DFT gradient test: s and p basis functions, B97-GGA1 functional;";;
    grad_ch5nos_bp86_631g)                testinfo="CH5NOS: DFT gradient test: s and p basis functions, BP86 functional";;
    grad_ch5nos_o3lyp_631g)               testinfo="CH5NOS: DFT gradient test: s and p basis functions, O3LYP functional";;
    grad_ch5nos_olyp_631g)                testinfo="CH5NOS: DFT gradient test: s and p basis functions, OLYP functional";;
    grad_ch5nos_pbe0_631g)                testinfo="CH5NOS: DFT gradient test: s and p basis functions, PBE0 functional";;
    grad_ch5nos_pbe_631g)                 testinfo="CH5NOS: DFT gradient test: s and p basis functions, PBE functional";;
    grad_ch5nos_pw91_631g)                testinfo="CH5NOS: DFT gradient test: s and p basis functions, PW91 functional";;
    grad_ch5nos_revpbe_631g)              testinfo="CH5NOS: DFT gradient test: s and p basis functions, revPBE functional";;
    grad_nma_rhf_def2tzvp)                testinfo="NMA: RHF gradient test with DEF2-TZVP basis set: s, p, d and f basis functions";;
    grad_wat_b3lyp_ccpvdz)                testinfo="Water: DFT point charge gradient test: s and p and d basis functions";;
    grad_c10h9o2s_b3lyp_def2svp)          testinfo="C10H9O2S: DFT point charge gradient test: s and p and d basis functions";;
    grad_daspi_meoh_b3lyp_sto3g)          testinfo="DASPI-DCM: DFT point charge gradient test: s and p basis functions";;
    grad_hbdi_meoh_libxc_blyp_sto3g)      testinfo="HBDI-MeOH: DFT point charge gradient test: s and p basis functions";;
    grad_naip_meoh_libxc_pbeh_sto3g)      testinfo="NAIP-MeOH: DFT point charge gradient test: s and p basis functions";;
    grad_ncnaip_b3lyp_sto3g)              testinfo="NAIP2-MeOH: DFT point charge gradient test: s and p basis functions";;
    grad_rpsb_meoh_rhf_sto3g)             testinfo="RPSB-MeOH: RHF point charge gradient test: s and p basis functions";;
    grad_daspi_meoh_b3lyp_6-31g)          testinfo="DASPI-DCM: DFT point charge gradient test: s and p basis functions";;
    grad_hbdi_meoh_libxc_blyp_def2sv_p)   testinfo="HBDI-MeOH: DFT point charge gradient test: s and p basis functions";;
    grad_naip_meoh_libxc_pbeh_def2svp)    testinfo="NAIP-MeOH: DFT point charge gradient test: s and p basis functions";;
    grad_ncnaip_b3lyp_631gss)             testinfo="NAIP2-MeOH: DFT point charge gradient test: s and p basis functions";;
    grad_rpsb_meoh_rhf_321g)              testinfo="RPSB-MeOH: RHF point charge gradient test: s and p basis functions";;
    grad_ohrad_b3lyp_631gss)              testinfo="OH radical: UDFT B3LYP gradient test";;
    opt_wat_rhf_631g)                     testinfo="Water: RHF geometry optimization test: s and p basis functions (Legacy optimizer)";;
    opt_wat_rhf_ccpvdz)                   testinfo="Water: RHF geometry optimization test: s, p and d basis functions (Legacy optimizer)";;
    opt_wat_b3lyp_ccpvtz)                 testinfo="Water: RHF geometry optimization test: s, p, d and f basis functions (Legacy optimizer)";;
    opt_nh4_pbe0_def2svp)                 testinfo="NH4+: DFT geometry optimization test: s, p and d basis functions (Legacy optimizer)";;
    opt_caffeine_b3lyp_3-21g)             testinfo="Caffeine: DFT B3LYP DL-FIND geometry optimization test: s and p basis functions (Baker test set)";;
    opt_merad_ub3lyp_631gss)              testinfo="Methyl radical: UDFT B3LYP geometry optimization test (Legacy optimizer)";;
    opt_hsoh_pbe0_def2svp)                testinfo="Oxadisulfane: DFT PBE0 DL-FIND geometry optimization test with s, p and d basis functions";;
    opt_c3h4_rhf_631g)                    testinfo="Allene: RHF DL-FIND geometry optimization test with s and p basis functions";;
    opt_c2h5rad_uhf_631gss)               testinfo="Ethyl radical: UHF DL-FIND geometry optimization test";;
    opt_c2hrad_ub3lyp_ccpvdz)             testinfo="Ethynyl radical: UDFT B3LYP DL-FIND geometry optimization test with s, p and d basis functions";;
    api_water_rhf_631g)                   testinfo="Water: API test";;
  esac

  echo $testinfo | tee -a $QUICK_HOME/.quick.${buildtype}.runtest.log

}

# function to set correct quick executable and test list
# must be called from a loop where $buildtype carries build type
set_qexe_testlist(){

  if [ "$buildtype" = 'serial' ]; then
    qexe='quick'
    apiexe='test-api'

    if [ -x "$testdir/test-api" ]; then
      apipath=$testdir
    elif [ -x "$qbindir/test-api" ]; then
      apipath=$qbindir
    fi

    if [ "$test_length" = 'full' ]; then
      test_list="$testdir/testlist_full.txt"
    else
      test_list="$testdir/testlist_short.txt"
    fi
  elif [ "$buildtype" = 'mpi' ]; then
    qexe='quick.MPI'
    apiexe='test-api.MPI'

    if [ -x "$testdir/test-api.MPI" ]; then
      apipath=$testdir
    elif [ -x "$qbindir/test-api.MPI" ]; then
      apipath=$qbindir
    fi

    if [ "$test_length" = 'full' ]; then
      test_list="$testdir/testlist_full.txt"
    else
      test_list="$testdir/testlist_short.txt"
    fi
  elif [ "$buildtype" = 'cuda' ]; then
    qexe='quick.cuda'
    apiexe='test-api.cuda'

    if [ -x "$testdir/test-api.cuda" ]; then
      apipath=$testdir
    elif [ -x "$qbindir/test-api.cuda" ]; then
      apipath=$qbindir
    fi

    if [ "$test_length" = 'full' ]; then
      test_list="$testdir/testlist_full_cuda.txt"
    else
      test_list="$testdir/testlist_short_cuda.txt"
    fi
  elif [ "$buildtype" = 'cudampi' ]; then
    qexe='quick.cuda.MPI'
    apiexe='test-api.cuda.MPI'

    if [ -x "$testdir/test-api.cuda.MPI" ]; then
      apipath=$testdir
    elif [ -x "$qbindir/test-api.cuda.MPI" ]; then
      apipath=$qbindir
    fi

    if [ "$test_length" = 'full' ]; then
      test_list="$testdir/testlist_full_cuda.txt"
    else
      test_list="$testdir/testlist_short_cuda.txt"
    fi
  elif [ "$buildtype" = 'hip' ]; then
    qexe='quick.hip'
    apiexe='test-api.hip'

    if [ -x "$testdir/test-api.hip" ]; then
      apipath=$testdir
    elif [ -x "$qbindir/test-api.hip" ]; then
      apipath=$qbindir
    fi

    if [ "$test_length" = 'full' ]; then
      test_list="$testdir/testlist_full_cuda.txt"
    else
      test_list="$testdir/testlist_short_cuda.txt"
    fi
  elif [ "$buildtype" = 'hipmpi' ]; then
    qexe='quick.hip.MPI'
    apiexe='test-api.hip.MPI'

    if [ -x "$testdir/test-api.hip.MPI" ]; then
      apipath=$testdir
    elif [ -x "$qbindir/test-api.hip.MPI" ]; then
      apipath=$qbindir
    fi

    if [ "$test_length" = 'full' ]; then
      test_list="$testdir/testlist_full_cuda.txt"
    else
      test_list="$testdir/testlist_short_cuda.txt"
    fi
  fi

}


# function to get the total number of tests
get_total_tests(){

  if [ "$test_ene" = 'yes' ]; then
    tot_ene_tests=`awk '{print $1}' "$test_list"| grep "ene" | wc -l`
    total_tests=$((total_tests+tot_ene_tests))
  fi

  if [ "$test_grad" = 'yes' ]; then
    tot_grad_tests=`awk '{print $1}' "$test_list"| grep "grad" | wc -l`
    total_tests=$((total_tests+tot_grad_tests))
  fi

  if [ "$test_opt" = 'yes' ]; then
    tot_opt_tests=`awk '{print $1}' "$test_list"| grep "opt" | wc -l`
    total_tests=$((total_tests+tot_opt_tests))
  fi

  if [ "$test_api" = 'yes' ]; then
    tot_api_tests=`awk '{print $1}' "$test_list"| grep "api" | wc -l`
    total_tests=$((total_tests+tot_api_tests))
  fi

}

# function to set files for a test run
set_test(){
  # copy input if the test is not an api test
  if [ `echo "$t" | grep 'api_' | wc -l` -lt 1 ]; then
    cp "$testdir/$t.in" ./
  fi

  cp "$testdir/saved/$t.out" "$t.ref.out"
}


# function to run tests. t, tc and total are test name, test count and 
# total test count respectively. accuracy sets the tolerance. 
run_test(){

    echo "Running test $tc of $total_tests" | tee -a $QUICK_HOME/.quick.${buildtype}.runtest.log

    print_test_info "$t"

    # Run the test case
    if [ $buildtype = 'mpi' ] || [ $buildtype = 'cudampi' ] || [ $buildtype = 'hipmpi' ] && [ $ismpirun = 'yes' ]; then
      $DO_PARALLEL "$qbindir/$qexe" "$t.in" > /dev/null 2>&1
    else
      "$qbindir/$qexe" "$t.in" > /dev/null 2>&1
    fi

    if [ "$?" -ne 0 ] && [ `check_f_error` -eq 0 ]; then
      echo "Error: $qexe execution failed."
      echo ""
      exit 1
    fi

    if [ `check_f_error` -eq 1 ]; then
      echo "SKIPPED."
      echo "=============================================================="
      echo ""
    fi
}

# function to run api tests
run_api_test(){
    echo "Running test $tc of $total_tests" | tee -a $QUICK_HOME/.quick.${buildtype}.runtest.log

    print_test_info "$t"
   
    #Run test
    if [ $buildtype = 'mpi' ] || [ $buildtype = 'cudampi' ] || [ $buildtype = 'hipmpi' ] && [ $ismpirun = 'yes' ]; then
      $DO_PARALLEL "$apipath/$apiexe" > /dev/null 2>&1
    else
      "$apipath/$apiexe" > /dev/null 2>&1
    fi

    if [ "$?" -ne 0 ]; then
      echo "Error: $apiexe execution failed."
      echo ""
      exit 1
    fi

}

# check electronic, nuclear and total energy
check_energy(){
    
    accuracy='4.0e-5'

    awk '/Begin Energy Calculation/,/End Energy calculation/ {print}' "$t.ref.out" > "$t.ref.ene"
    awk '/Begin Energy Calculation/,/End Energy calculation/ {print}' "$t.out" > "$t.ene"

    "$testdir/dacdif" -k -a "$accuracy" "$t.ref.ene" "$t.ene" | tee -a $QUICK_HOME/.quick.${buildtype}.runtest.log

}


# check nuclear and point charge gradients
check_gradient(){

    accuracy='4.0e-3'

    awk '/Begin Gradient Calculation/,/End Gradient Calculation/ {print}' "$t.ref.out" > "$t.ref.grad"
    awk '/Begin Gradient Calculation/,/End Gradient Calculation/ {print}' "$t.out" > "$t.grad"

    "$testdir/dacdif" -k -a "$accuracy" "$t.ref.grad" "$t.grad" | tee -a $QUICK_HOME/.quick.${buildtype}.runtest.log
}

# check optimized geometry and force element
check_opt(){

    accuracy='4.0e-3'

    awk '/GEOMETRY INFORMATION/,/Finish Optimization Job/ {print}' "$t.ref.out" > "$t.ref.opt"
    awk '/GEOMETRY INFORMATION/,/Finish Optimization Job/ {print}' "$t.out" > "$t.opt"

    "$testdir/dacdif" -k -a "$accuracy" "$t.ref.opt" "$t.opt" | tee -a $QUICK_HOME/.quick.${buildtype}.runtest.log

}

# check mulliken charges and dipole
check_dipole(){

    accuracy='4.0e-3'

    awk '/Begin Charge and Dipole Calculation/,/End Charge and Dipole Calculation/ {print}' "$t.ref.out" > "$t.ref.dipole"
    awk '/Begin Charge and Dipole Calculation/,/End Charge and Dipole Calculation/ {print}' "$t.out" > "$t.dipole"

    "$testdir/dacdif" -k -a "$accuracy" "$t.ref.dipole" "$t.dipole" | tee -a $QUICK_HOME/.quick.${buildtype}.runtest.log

}

# function to clean up files
clean_up(){

    rm -f "$t.ref.out" "$t.in" ddtmp* *.ene *.grad *.dipole *.opt

}

# function to report summary
print_summary(){

  sum_header="======================== Test Summary ========================"
  sum_footer="=============================================================="  

  echo "$sum_header"
  echo ""

  if [ "$log" = 'yes' ]; then
    echo "$sum_header" > $QUICK_HOME/.quick.runtest.summary.log
    echo "" >> $QUICK_HOME/.quick.runtest.summary.log
  fi


  for buildtype in $buildtypes; do
    total_ene=0
    total_grad=0
    total_opt=0
    total_api=0
    failed_ene=0
    failed_grad=0
    failed_opt=0
    failed_api=0
    total_tests=0
 
    # set testlist
    set_qexe_testlist
 
    # get the number of tests to run
    get_total_tests
 
    # grab stuff from temporary log files
    sed -n '/'$buildtype' version started/,/All '$buildtype' tests are done/p' $QUICK_HOME/.quick.${buildtype}.runtest.log > .quick.runtest.${buildtype}.summary.tmp1
 
    for i in `seq 1 $total_tests`; do
      if [ "$i" -lt "$total_tests" ]; then
        j=$((i+1))
        sed -n '/Running test '$i' of '$total_tests'/,/Running test '$j' of '$total_tests'/p' .quick.runtest.${buildtype}.summary.tmp1 > .quick.runtest.${buildtype}.summary.tmp2
      elif [ "$i" -eq "$total_tests" ]; then
        sed -n '/Running test '$total_tests'/,/All '$buildtype' tests are done/p' .quick.runtest.${buildtype}.summary.tmp1 > .quick.runtest.${buildtype}.summary.tmp2
      fi
  
      if [ `sed -n '/energy test/p' .quick.runtest.${buildtype}.summary.tmp2 | wc -l` -gt 0 ]; then
        total_ene=$((total_ene+1))
        if [ `sed -n '/possible FAILURE/p' .quick.runtest.${buildtype}.summary.tmp2 | wc -l` -gt 0 ]; then
          failed_ene=$((failed_ene+1))
        fi
        
      elif [ `sed -n '/gradient test/p' .quick.runtest.${buildtype}.summary.tmp2 | wc -l` -gt 0 ]; then
        total_grad=$((total_grad+1))
        if [ `sed -n '/possible FAILURE/p' .quick.runtest.${buildtype}.summary.tmp2 | wc -l` -gt 0 ]; then
          failed_grad=$((failed_grad+1))
        fi
      elif [ `sed -n '/geometry optimization test/p' .quick.runtest.${buildtype}.summary.tmp2 | wc -l` -gt 0 ]; then
        total_opt=$((total_opt+1))
        if [ `sed -n '/possible FAILURE/p' .quick.runtest.${buildtype}.summary.tmp2 | wc -l` -gt 0 ]; then
          failed_opt=$((failed_opt+1))
        fi
      elif [ `sed -n '/API test/p' .quick.runtest.${buildtype}.summary.tmp2 | wc -l` -gt 0 ]; then
        total_api=$((total_api+1))
        if [ `sed -n '/possible FAILURE/p' .quick.runtest.${buildtype}.summary.tmp2 | wc -l` -gt 0 ]; then
          failed_api=$((failed_api+1))
        fi
      fi
      
      rm -f .quick.runtest.${buildtype}.summary.tmp2
    done
    
    failed_total=$((failed_ene+failed_grad+failed_opt+failed_api))

    # update cumulative failed tests too
    ncum_failed_tests=$((ncum_failed_tests+failed_total))

    echo "$buildtype version:" > .quick.runtest.${buildtype}.summary.tmp0
    echo "    Energy tests: $failed_ene/$total_ene (failed/total)" >> .quick.runtest.${buildtype}.summary.tmp0
    echo "    Gradient tests: $failed_grad/$total_grad (failed/total)" >> .quick.runtest.${buildtype}.summary.tmp0
    echo "    Optimization tests: $failed_opt/$total_opt (failed/total)" >> .quick.runtest.${buildtype}.summary.tmp0
    echo "    API tests: $failed_api/$total_api (failed/total)" >> .quick.runtest.${buildtype}.summary.tmp0
    echo "    Total tests: $failed_total/$total_tests (failed/total)" >> .quick.runtest.${buildtype}.summary.tmp0
    echo "" >> .quick.runtest.${buildtype}.summary.tmp0
 
    cat .quick.runtest.${buildtype}.summary.tmp0
 
    if [ "$log" = 'yes' ]; then 
      cat .quick.runtest.${buildtype}.summary.tmp0 >> $QUICK_HOME/.quick.runtest.summary.log
    fi
 
    rm -f .quick.runtest.${buildtype}.summary.tmp1 .quick.runtest.${buildtype}.summary.tmp0
    
  done

  echo "$sum_footer"

  if [ "$log" = 'yes' ]; then
    echo "$sum_footer" >> $QUICK_HOME/.quick.runtest.summary.log
  fi

}

# Function to skip F tests if the code wasnt compiled with support
check_f_error(){
    f_error_string=`grep 'Error: Support for F functions is disabled' "$t.out"`

    if [ -z "$f_error_string" ]; then echo 0 ; else echo 1 ; fi

}

#  !---------------------------------------------------------------------!
#  ! Read input                                                          !
#  !---------------------------------------------------------------------

while [ $# -gt 0 ]; do
  case "$1" in
    --serial)      serial='yes'; buildtypes="$buildtypes serial";;
    --mpi)         mpi='yes'; buildtypes="$buildtypes mpi";;
    --cuda)        cuda='yes'; buildtypes="$buildtypes cuda";;
    --cudampi)     cudampi='yes'; buildtypes="$buildtypes cudampi";;
    --hip)         hip='yes'; buildtypes="$buildtypes hip";;
    --hipmpi)      hipmpi='yes'; buildtypes="$buildtypes hipmpi";;
    --ene)         test_ene='yes';uspec_test='yes';;
    --grad)        test_grad='yes';uspec_test='yes';;
    --opt)         test_opt='yes';uspec_test='yes';;
    --api)         test_api='yes';uspec_test='yes';;
    --full)        test_length='full';;
    --nolog)       log='no';;   
    -h| -H| -help| --help) print_help;;
     *) 
         echo  "Neglecting unknown flag: $1";;
  esac
  shift
done

#  !---------------------------------------------------------------------!
#  ! Check directories & executables                                     !
#  !---------------------------------------------------------------------!

if [ ! -d "$qbindir" ]; then
  echo  "Error: QUICK bin folder not found. "
  exit 1
fi

if [ ! -d "$qbasisdir" ]; then
  echo  "Error: QUICK basis folder not found. "
  exit 1
else
  export QUICK_BASIS=$qbasisdir
fi

if [ ! -d "$testdir" ]; then
  echo  "Error: QUICK test folder not found. "
  exit 1
fi

if [ "$serial" = 'yes' -o "$mpi" = 'yes' -o "$cuda" = 'yes' -o "$cudampi" = 'yes' -o "$hip" = 'yes' -o "$hipmpi" = 'yes' ]; then

  if [ "$serial" = 'yes' ]; then
    if [ ! -x "$qbindir/quick" ]; then
      echo  "Error: $qbindir/quick not found."
      exit 1
    fi
    if ! [ -x "$testdir/test-api" -o -x "$qbindir/test-api" ]; then
      echo  "Error: test-api not found in $testdir or $qbindir."
      exit 1
    fi
  fi

  if [ "$mpi" = 'yes' ]; then
    if [ ! -x "$qbindir/quick.MPI" ]; then
      echo  "Error: $qbindir/quick.MPI not found."
      exit 1
    fi
    if ! [ -x "$testdir/test-api.MPI" -o -x "$qbindir/test-api.MPI" ]; then
      echo  "Error: test-api.MPI not found in $testdir or $qbindir."
      exit 1
    fi
  fi

  if [ "$cuda" = 'yes' ]; then
    if [ ! -x "$qbindir/quick.cuda" ]; then
      echo  "Error: $qbindir/quick.cuda not found."
      exit 1
    fi
    if ! [ -x "$testdir/test-api.cuda" -o -x "$qbindir/test-api.cuda" ]; then
      echo  "Error: test-api.cuda not found in $testdir or $qbindir."
      exit 1
    fi
  fi

  if [ "$cudampi" = 'yes' ]; then
    if [ ! -x "$qbindir/quick.cuda.MPI" ]; then
      echo  "Error: $qbindir/quick.cuda.MPI not found."
      exit 1
    fi
    if ! [ -x "$testdir/test-api.cuda.MPI" -o -x "$qbindir/test-api.cuda.MPI" ]; then
      echo  "Error: test-api.cuda.MPI not found in $testdir or $qbindir."
      exit 1
    fi
  fi

  if [ "$hip" = 'yes' ]; then
    if [ ! -x "$qbindir/quick.hip" ]; then
      echo  "Error: $qbindir/quick.hip not found."
      exit 1
    fi
    if ! [ -x "$testdir/test-api.hip" -o -x "$qbindir/test-api.hip" ]; then
      echo  "Error: test-api.hip not found in $testdir or $qbindir."
      exit 1
    fi
  fi

  if [ "$hipmpi" = 'yes' ]; then
    if [ ! -x "$qbindir/quick.hip.MPI" ]; then
      echo  "Error: $qbindir/quick.hip.MPI not found."
      exit 1
    fi
    if ! [ -x "$testdir/test-api.hip.MPI" -o -x "$qbindir/test-api.hip.MPI" ]; then
      echo  "Error: test-api.hip.MPI not found in $testdir or $qbindir."
      exit 1
    fi
  fi

else

  # automatically check for executables
  if [ -x "$qbindir/quick.cuda.MPI" ]; then
    cudampi='yes'
    buildtypes="$buildtypes cudampi"
  fi

  if [ -x "$qbindir/quick.cuda" ]; then
    cuda='yes'
    buildtypes="$buildtypes cuda"
  fi

  if [ -x "$qbindir/quick.hip.MPI" ]; then
    hipmpi='yes'
    buildtypes="$buildtypes hipmpi"
  fi

  if [ -x "$qbindir/quick.hip" ]; then
    hip='yes'
    buildtypes="$buildtypes hip"
  fi

  if [ -x "$qbindir/quick.MPI" ]; then
    mpi='yes'
    buildtypes="$buildtypes mpi"
  fi

  if [ -x "$qbindir/quick" ]; then
    serial='yes'
    buildtypes="$buildtypes serial"
  fi

  if [ "$serial" = 'no' -a "$mpi" = 'no' -a "$cuda" = 'no' -a "$cudampi" = 'no' -a "$hip" = 'no' -a "$hipmpi" = 'no' ]; then
    echo  "Error: No QUICK executables found in $qbindir. "
    exit 1
  fi

fi

if [ ! -f "$testdir/testlist_short.txt" ]; then
  echo  "Error: testlist_short.txt not found in $testdir. "
  exit 1
fi

if [ ! -f "$testdir/testlist_full.txt" ]; then
  echo  "Error: testlist_full.txt not found in $testdir. "
  exit 1
fi

if [ ! -f "$testdir/testlist_short_cuda.txt" ]; then
  echo  "Error: testlist_short_cuda.txt not found in $testdir. "
  exit 1
fi

if [ ! -f "$testdir/testlist_full_cuda.txt" ]; then
  echo  "Error: testlist_full_cuda.txt not found in $testdir. "
  exit 1
fi


# check for mpirun 
if [ "$mpi" = 'yes' -o "$cudampi" = 'yes' -o "$hipmpi" = 'yes' ]; then
   mpimsg=""
   if [ -z "$DO_PARALLEL" ]; then
     echo "Error: MPI/CUDAMPI tests are requested but DO_PARALLEL variable is not set."
     exit 1
   else
     ismpirun='yes'
     mpimsg="MPI command: $DO_PARALLEL"
   fi
 
   echo ""
   echo "$mpimsg"   
 
   if [ "$mpi" = 'yes' ]; then
     echo "" >> $QUICK_HOME/.quick.mpi.runtest.log
     echo "$mpimsg" >> $QUICK_HOME/.quick.mpi.runtest.log 
   fi
 
   if [ "$cudampi" = 'yes' ]; then
     echo "" >> $QUICK_HOME/.quick.cudampi.runtest.log
     echo "$mpimsg" >> $QUICK_HOME/.quick.cudampi.runtest.log
   fi

   if [ "$hipmpi" = 'yes' ]; then
     echo "" >> $QUICK_HOME/.quick.hipmpi.runtest.log
     echo "$mpimsg" >> $QUICK_HOME/.quick.hipmpi.runtest.log
   fi

fi

#  !---------------------------------------------------------------------!
#  ! Create required directories                                         !
#  !---------------------------------------------------------------------!

if [ ! -d "$testdir/runs" ]; then
  mkdir -p "$testdir/runs"
fi

for buildtype in $buildtypes; do
  rm -rf "$testdir/runs/$buildtype"
  mkdir -p "$testdir/runs/$buildtype"
done

#  !---------------------------------------------------------------------!
#  ! Set test tyeps                                                      !
#  !---------------------------------------------------------------------!

if [ "$uspec_test" = 'no' ]; then
  test_ene='yes'
  test_grad='yes'
  test_opt='yes'
  test_api='yes'
fi

#  !---------------------------------------------------------------------!
#  ! Run tests                                                           !
#  !---------------------------------------------------------------------!

cd "$testdir"


for buildtype in $buildtypes; do

  cdate=`date +'%m/%d/%Y'`
  ctime=`date +'%r'`

  echo "" | tee -a $QUICK_HOME/.quick.${buildtype}.runtest.log
  echo  "Testing $QUICK_VERSION $buildtype version started on $cdate at $ctime. " | tee -a $QUICK_HOME/.quick.${buildtype}.runtest.log
  echo "" | tee -a $QUICK_HOME/.quick.${buildtype}.runtest.log
  

  # set qexe and testlist
  set_qexe_testlist

  # initialize the total number of test cases
  total_tests=0 

  # get the number of tests to run
  get_total_tests

  tc=1 # test count
  cd "$testdir/runs/$buildtype"

  # Run energy tests
  if [ "$test_ene" = 'yes' ]; then
    for t in `awk '{print $1}' "$test_list"| grep "ene"`; do
      set_test
      run_test
      if [ `check_f_error` -eq 0 ]; then
          check_energy
          check_dipole
          clean_up
         
          echo ""
      fi
      tc=$((tc+1))
    done
  fi

  # Run gradient tests
  if [ "$test_grad" = 'yes' ]; then
    for t in `awk '{print $1}' "$test_list" |grep "grad"`; do
      set_test
      run_test
      if [ `check_f_error` -eq 0 ]; then
          check_energy
          check_gradient
          check_dipole
          clean_up
        
          echo ""
      fi
      tc=$((tc+1))
    done
  fi

  # Run geometry optimization tests
  if [ "$test_opt" = 'yes' ]; then
    for t in `awk '{print $1}' "$test_list" | grep "opt"`; do
      set_test
      run_test
      if [ `check_f_error` -eq 0 ]; then
          check_opt
          check_dipole
          clean_up
         
          echo ""
      fi
      tc=$((tc+1))
    done
  fi

  # Run api tests
  if [ "$test_api" = 'yes' ]; then
    for t in `awk '{print $1}' "$test_list" | grep "api_"`; do
      set_test
      run_api_test
      check_energy
      check_gradient
      clean_up
    done
  fi

  echo "All $buildtype tests are done. The output files are located in $testdir/runs/$buildtype." | tee -a $QUICK_HOME/.quick.${buildtype}.runtest.log
  echo "" | tee -a $QUICK_HOME/.quick.${buildtype}.runtest.log

  cd "$testdir"
done
  
cd $installdir

# print test summary
print_summary

# create final .log file or delete temp .log files
if [ "$log" = 'yes' ]; then
  touch runtest.log
  for buildtype in $buildtypes; do
    cat $QUICK_HOME/.quick.${buildtype}.runtest.log >> $QUICK_HOME/runtest.log
    rm -f $QUICK_HOME/.quick.${buildtype}.runtest.log
  done
  cat $QUICK_HOME/.quick.runtest.summary.log >> $QUICK_HOME/runtest.log
  rm -f $QUICK_HOME/.quick.runtest.summary.log

  echo "Output of runtest script has been written into $QUICK_HOME/runtest.log file."
else
  for buildtype in $buildtypes; do
    rm -f $QUICK_HOME/.quick.${buildtype}.runtest.log
  done
fi

# shamefully exit if tests are failed.
if [ $ncum_failed_tests -gt 0 ]; then
  exit 1
else
  exit 0
fi

