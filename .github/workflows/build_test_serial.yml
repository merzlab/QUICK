name: 'Build and Test QUICK Serial Version'

defaults:
  run:
    shell: bash

on:
  push:
    paths-ignore:
      - '**.md'
  pull_request:
    paths-ignore:
      - '**.md'

jobs:
  build-and-test-serial-legacy-configure-make:
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: 'ubuntu-22.04'
            compiler-type: 'gnu'
            compiler-version: '10'
            c-compiler: 'gcc'
            cxx-compiler: 'g++'
            fortran-compiler: 'gfortran'
            compiler-install: 'gcc-10 g++-10 gfortran-10'
            hdf5-install: 'libhdf5-dev'
          - os: 'ubuntu-22.04'
            compiler-type: 'gnu'
            compiler-version: '11'
            c-compiler: 'gcc'
            cxx-compiler: 'g++'
            fortran-compiler: 'gfortran'
            compiler-install: 'gcc-11 g++-11 gfortran-11'
            hdf5-install: 'libhdf5-dev'
          - os: 'ubuntu-24.04'
            compiler-type: 'gnu'
            compiler-version: '12'
            c-compiler: 'gcc'
            cxx-compiler: 'g++'
            fortran-compiler: 'gfortran'
            compiler-install: 'gcc-12 g++-12 gfortran-12'
            hdf5-install: 'libhdf5-dev'
          - os: 'ubuntu-24.04'
            compiler-type: 'gnu'
            compiler-version: '13'
            c-compiler: 'gcc'
            cxx-compiler: 'g++'
            fortran-compiler: 'gfortran'
            compiler-install: 'gcc-13 g++-13 gfortran-13'
            hdf5-install: 'libhdf5-dev'
          - os: 'ubuntu-24.04'
            compiler-type: 'gnu'
            compiler-version: '14'
            c-compiler: 'gcc'
            cxx-compiler: 'g++'
            fortran-compiler: 'gfortran'
            compiler-install: 'gcc-14 g++-14 gfortran-14'
            hdf5-install: 'libhdf5-dev'
          - os: 'ubuntu-24.04-arm'
            compiler-type: 'gnu'
            compiler-version: '14'
            c-compiler: 'gcc'
            cxx-compiler: 'g++'
            fortran-compiler: 'gfortran'
            compiler-install: 'gcc-14 g++-14 gfortran-14'
            hdf5-install: 'libhdf5-dev'
    runs-on: ${{ matrix.os }}
    name: ${{ matrix.os }} - Serial - Legacy - ${{ matrix.compiler-type }} - ${{ matrix.compiler-version }}
    steps:
      - name: 'Checkout Repository'
        uses: actions/checkout@v4
      - name: 'Install Dependencies for Serial Version'
        run: |
          if [ "$RUNNER_OS" == "Linux" ]; then
            sudo apt-get update
            sudo apt-get upgrade
            sudo apt-get install -y ${{ matrix.compiler-install }} parallel ${{ matrix.hdf5-install }}
            if [[ ${{ matrix.compiler-type }} == 'gnu' || ${{ matrix.compiler-type }} == 'clang' ]]; then
              sudo rm /usr/bin/${{ matrix.c-compiler }}
              sudo ln -s -T ${{ matrix.c-compiler }}-${{ matrix.compiler-version }} /usr/bin/${{ matrix.c-compiler }}
              sudo rm /usr/bin/${{ matrix.cxx-compiler }}
              sudo ln -s -T ${{ matrix.cxx-compiler }}-${{ matrix.compiler-version }} /usr/bin/${{ matrix.cxx-compiler }}
              if [[ ${{ matrix.compiler-type }} == 'gnu' ]]; then
                sudo rm /usr/bin/${{ matrix.fortran-compiler }}
                sudo ln -s -T ${{ matrix.fortran-compiler }}-${{ matrix.compiler-version }} /usr/bin/${{ matrix.fortran-compiler }}
              fi
            fi
            sudo apt-get clean
          fi
      - name: 'Log Softare Environment Configuration'
        run: |
          if [ "$RUNNER_OS" == "Linux" ]; then
            echo "OS version:"
            cat /etc/os-release
            echo
            echo "Kernel version:"
            uname -a
            echo
            ldd --version
            echo
            echo "Fortran compiler version:"
            ${{ matrix.fortran-compiler }} --version
            echo
            echo "GNU Parallel version:"
            parallel --version
          fi
      - name: 'Setup Environment Variables for Building and Running Tests'
        run: |
          echo "QUICK_BASIS=$PWD/install/basis" >> "$GITHUB_ENV"
          echo "PATH=$PWD/install/bin:$PATH" >> "$GITHUB_ENV"
          echo "LIBRARY_PATH=$PWD/install/lib/serial:/usr/lib/`uname -m`-linux-gnu/hdf5/serial:$LIBRARY_PATH" >> "$GITHUB_ENV"
          echo "LD_LIBRARY_PATH=$PWD/install/lib/serial:/usr/lib/`uname -m`-linux-gnu/hdf5/serial:$LD_LIBRARY_PATH" >> "$GITHUB_ENV"
          echo "PARALLEL_TEST_COUNT=2" >> "$GITHUB_ENV"
          echo "CC=${{ matrix.c-compiler }}" >> "$GITHUB_ENV"
          echo "CXX=${{ matrix.cxx-compiler }}" >> "$GITHUB_ENV"
          echo "FC=${{ matrix.fortran-compiler }}" >> "$GITHUB_ENV"
          echo "HDF5_FORTRAN_MOD_DIR=/usr/include/hdf5/serial" >> "$GITHUB_ENV"
      - name: 'Configure Serial Version'
        run: |
          ./configure --serial --hdf5 --enablef --shared --verbose --prefix $PWD/install \
            ${{ matrix.compiler-type }}
      - name: 'Build and Install Serial Version Using 2 Jobs'
        run: |
          make -j2 all install
      - name: 'Run Tests for Serial Version (Make)'
        run: |
          make fulltest
      - name: 'Upload Test Artifacts for Serial Version'
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: serial-legacy-configure-make-tests-${{ matrix.os }}-${{ matrix.compiler-type }}-${{ matrix.compiler-version }}
          path: |
            ${{ github.workspace }}/install/runtest.log
            ${{ github.workspace }}/install/runtest-verbose.log
            ${{ github.workspace }}/install/test/runs/serial
          retention-days: 3
          compression-level: 6
      - name: 'Download Test Artifacts for Serial Version'
        uses: actions/download-artifact@v4
        with:
          name: serial-legacy-configure-make-tests-${{ matrix.os }}-${{ matrix.compiler-type }}-${{ matrix.compiler-version }}
      - name: 'Display Artifacts'
        run: |
          ls -R
  build-and-test-serial-cmake:
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: 'ubuntu-22.04'
            compiler-type: 'GNU'
            compiler-version: '10'
            c-compiler: 'gcc'
            cxx-compiler: 'g++'
            fortran-compiler: 'gfortran'
            compiler-install: 'gcc-10 g++-10 gfortran-10'
            hdf5-install: 'libhdf5-dev'
            hdf5-restart-support: TRUE
          - os: 'ubuntu-22.04'
            compiler-type: 'GNU'
            compiler-version: '11'
            c-compiler: 'gcc'
            cxx-compiler: 'g++'
            fortran-compiler: 'gfortran'
            compiler-install: 'gcc-11 g++-11 gfortran-11'
            hdf5-install: 'libhdf5-dev'
            hdf5-restart-support: TRUE
          - os: 'ubuntu-24.04'
            compiler-type: 'GNU'
            compiler-version: '12'
            c-compiler: 'gcc'
            cxx-compiler: 'g++'
            fortran-compiler: 'gfortran'
            compiler-install: 'gcc-12 g++-12 gfortran-12'
            hdf5-install: 'libhdf5-dev'
            hdf5-restart-support: TRUE
          - os: 'ubuntu-24.04'
            compiler-type: 'GNU'
            compiler-version: '13'
            c-compiler: 'gcc'
            cxx-compiler: 'g++'
            fortran-compiler: 'gfortran'
            compiler-install: 'gcc-13 g++-13 gfortran-13'
            hdf5-install: 'libhdf5-dev'
            hdf5-restart-support: TRUE
          - os: 'ubuntu-24.04'
            compiler-type: 'GNU'
            compiler-version: '14'
            c-compiler: 'gcc'
            cxx-compiler: 'g++'
            fortran-compiler: 'gfortran'
            compiler-install: 'gcc-14 g++-14 gfortran-14'
            hdf5-install: 'libhdf5-dev'
            hdf5-restart-support: TRUE
          - os: 'ubuntu-24.04'
            compiler-type: 'CLANG'
            compiler-version: '17'
            c-compiler: 'clang'
            cxx-compiler: 'clang++'
            fortran-compiler: 'gfortran'
            compiler-install: 'clang-17 gfortran'
            hdf5-install: 'libhdf5-dev'
            hdf5-restart-support: TRUE
          - os: 'ubuntu-24.04'
            compiler-type: 'CLANG'
            compiler-version: '18'
            c-compiler: 'clang'
            cxx-compiler: 'clang++'
            fortran-compiler: 'gfortran'
            compiler-install: 'clang-18 gfortran'
            hdf5-install: 'libhdf5-dev'
            hdf5-restart-support: TRUE
          - os: 'ubuntu-24.04'
            compiler-type: 'INTELLLVM'
            compiler-version: '2024.2.1'
            c-compiler: 'icx'
            cxx-compiler: 'icpx'
            fortran-compiler: 'ifx'
            compiler-install: 'intel-oneapi-compiler-dpcpp-cpp-2024.2 intel-oneapi-compiler-fortran-2024.2 intel-oneapi-mkl-2024.2 intel-oneapi-mkl-devel-2024.2'
            hdf5-install: ''
            hdf5-restart-support: FALSE
          - os: 'ubuntu-24.04'
            compiler-type: 'INTELLLVM'
            compiler-version: '2025.0.1'
            c-compiler: 'icx'
            cxx-compiler: 'icpx'
            fortran-compiler: 'ifx'
            compiler-install: 'intel-oneapi-compiler-dpcpp-cpp-2025.0 intel-oneapi-compiler-fortran-2025.0 intel-oneapi-mkl-2025.0 intel-oneapi-mkl-devel-2025.0'
            hdf5-install: ''
            hdf5-restart-support: FALSE
          - os: 'ubuntu-24.04'
            compiler-type: 'PGI'
            compiler-version: '25.1'
            c-compiler: 'pgcc'
            cxx-compiler: 'pgcc++'
            fortran-compiler: 'pgf90'
            compiler-install: 'nvhpc-25-1 gfortran'
            hdf5-install: ''
            hdf5-restart-support: FALSE
          - os: 'ubuntu-24.04-arm'
            compiler-type: 'GNU'
            compiler-version: '14'
            c-compiler: 'gcc'
            cxx-compiler: 'g++'
            fortran-compiler: 'gfortran'
            compiler-install: 'gcc-14 g++-14 gfortran-14'
            hdf5-install: 'libhdf5-dev'
            hdf5-restart-support: TRUE
          - os: 'ubuntu-24.04-arm'
            compiler-type: 'CLANG'
            compiler-version: '18'
            c-compiler: 'clang'
            cxx-compiler: 'clang++'
            fortran-compiler: 'gfortran'
            compiler-install: 'clang-18 gfortran'
            hdf5-install: 'libhdf5-dev'
            hdf5-restart-support: TRUE
          - os: 'macos-14'
            compiler-type: 'GNU'
            compiler-version: '15'
            c-compiler: 'gcc'
            cxx-compiler: 'g++'
            fortran-compiler: 'gfortran'
            compiler-install: 'gcc@15'
            hdf5-install: 'hdf5'
            hdf5-restart-support: TRUE
          - os: 'macos-14'
            compiler-type: 'CLANG'
            compiler-version: '20'
            fortran-compiler-version: '15'
            c-compiler: 'clang'
            cxx-compiler: 'clang++'
            fortran-compiler: 'gfortran'
            compiler-install: 'llvm@20 gcc@15'
            hdf5-install: 'hdf5'
            hdf5-restart-support: TRUE
          - os: 'macos-15'
            compiler-type: 'GNU'
            compiler-version: '15'
            c-compiler: 'gcc'
            cxx-compiler: 'g++'
            fortran-compiler: 'gfortran'
            compiler-install: 'gcc@15'
            hdf5-install: 'hdf5'
            hdf5-restart-support: TRUE
          - os: 'macos-15'
            compiler-type: 'CLANG'
            compiler-version: '20'
            fortran-compiler-version: '15'
            c-compiler: 'clang'
            cxx-compiler: 'clang++'
            fortran-compiler: 'gfortran'
            compiler-install: 'llvm@20 gcc@15'
            hdf5-install: 'hdf5'
            hdf5-restart-support: TRUE
    runs-on: ${{ matrix.os }}
    name: ${{ matrix.os }} - Serial - CMake - ${{ matrix.compiler-type }} - ${{ matrix.compiler-version }}
    steps:
      - name: 'Checkout Repository'
        uses: actions/checkout@v4
      - name: 'Setup Environment Variables for Building and Running Tests'
        run: |
          echo "QUICK_BASIS=$PWD/install/basis" >> "$GITHUB_ENV"
          if [ "$RUNNER_OS" == "Linux" ]; then
            if [ ${{ matrix.compiler-type }} == 'PGI' ]; then
              echo "PATH=$PWD/install/bin:/opt/nvidia/hpc_sdk/`uname -s`_`uname -m`/${{ matrix.compiler-version }}/compilers/bin:$PATH" >> "$GITHUB_ENV"
              echo "INCLUDE_PATH=/opt/nvidia/hpc_sdk/`uname -s`_`uname -m`/${{ matrix.compiler-version }}/compilers/include:$INCLUDE_PATH" >> "$GITHUB_ENV"
              echo "LIBRARY_PATH=$PWD/install/lib:/opt/nvidia/hpc_sdk/`uname -s`_`uname -m`/${{ matrix.compiler-version }}/compilers/lib:$LIBRARY_PATH" >> "$GITHUB_ENV"
              echo "LD_LIBRARY_PATH=$PWD/install/lib:/opt/nvidia/hpc_sdk/`uname -s`_`uname -m`/${{ matrix.compiler-version }}/compilers/lib:$LD_LIBRARY_PATH" >> "$GITHUB_ENV"
              echo "CMAKE_PREFIX_PATH=/opt/nvidia/hpc_sdk/`uname -s`_`uname -m`/${{ matrix.compiler-version }}/compilers/:$CMAKE_PREFIX_PATH" >> "$GITHUB_ENV"
              echo "NVHPC=/opt/nvidia/hpc_sdk" >> "$GITHUB_ENV"
              echo "NVHPC_ROOT=/opt/nvidia/hpc_sdk/`uname -s`_`uname -m`/${{ matrix.compiler-version }}" >> "$GITHUB_ENV"
            else
              echo "PATH=$PWD/install/bin:$PATH" >> "$GITHUB_ENV"
              echo "LIBRARY_PATH=$PWD/install/lib:$LIBRARY_PATH" >> "$GITHUB_ENV"
              echo "LD_LIBRARY_PATH=$PWD/install/lib:$LD_LIBRARY_PATH" >> "$GITHUB_ENV"
            fi
          fi
          echo "PARALLEL_TEST_COUNT=2" >> "$GITHUB_ENV"
          echo "CC=${{ matrix.c-compiler }}" >> "$GITHUB_ENV"
          echo "CXX=${{ matrix.cxx-compiler }}" >> "$GITHUB_ENV"
          echo "FC=${{ matrix.fortran-compiler }}" >> "$GITHUB_ENV"
          if [ "$RUNNER_OS" == "macOS" ]; then
            echo "BREW_COMPILER_PREFIX=$(brew --prefix)/bin" >> "$GITHUB_ENV"
            if [[ ${{ matrix.compiler-type }} == 'GNU' ]]; then
              echo "PATH=$(brew --prefix)/bin:$PATH" >> "$GITHUB_ENV"
            elif [[ ${{ matrix.compiler-type }} == 'CLANG' ]]; then
              echo "PATH=$(brew --prefix)/bin:$(brew --prefix)/opt/llvm@${{ matrix.compiler-version }}/bin:$PATH" >> "$GITHUB_ENV"
            fi
          fi
      - name: 'Install Dependencies for Serial Version'
        run: |
          if [ "$RUNNER_OS" == "Linux" ]; then
            sudo apt-get update
            sudo apt-get upgrade
            if [ ${{ matrix.compiler-type }} == 'INTELLLVM' ]; then
              sudo apt-get install -y gpg-agent wget
              wget -O- https://apt.repos.intel.com/intel-gpg-keys/GPG-PUB-KEY-INTEL-SW-PRODUCTS.PUB \
                | gpg --dearmor | sudo tee /usr/share/keyrings/oneapi-archive-keyring.gpg > /dev/null
              echo "deb [signed-by=/usr/share/keyrings/oneapi-archive-keyring.gpg] https://apt.repos.intel.com/oneapi all main" \
                | sudo tee /etc/apt/sources.list.d/oneAPI.list
              sudo apt-get update
            elif [ ${{ matrix.compiler-type }} == 'PGI' ]; then
              sudo apt-get install -y gpg-agent wget
              wget -O- https://developer.download.nvidia.com/hpc-sdk/ubuntu/DEB-GPG-KEY-NVIDIA-HPC-SDK \
                | gpg --dearmor | sudo tee /usr/share/keyrings/nvidia-hpcsdk-archive-keyring.gpg > /dev/null
              echo "deb [signed-by=/usr/share/keyrings/nvidia-hpcsdk-archive-keyring.gpg] https://developer.download.nvidia.com/hpc-sdk/ubuntu/amd64 /" \
                | sudo tee /etc/apt/sources.list.d/nvhpc.list
              sudo apt-get update
            fi
            sudo apt-get install -y ${{ matrix.compiler-install }} cmake parallel ${{ matrix.hdf5-install }}
            if [[ ${{ matrix.compiler-type }} == 'GNU' || ${{ matrix.compiler-type }} == 'CLANG' ]]; then
              sudo rm /usr/bin/${{ matrix.c-compiler }}
              sudo ln -s -T ${{ matrix.c-compiler }}-${{ matrix.compiler-version }} /usr/bin/${{ matrix.c-compiler }}
              sudo rm /usr/bin/${{ matrix.cxx-compiler }}
              sudo ln -s -T ${{ matrix.cxx-compiler }}-${{ matrix.compiler-version }} /usr/bin/${{ matrix.cxx-compiler }}
              if [[ ${{ matrix.compiler-type }} == 'GNU' ]]; then
                sudo rm /usr/bin/${{ matrix.fortran-compiler }}
                sudo ln -s -T ${{ matrix.fortran-compiler }}-${{ matrix.compiler-version }} /usr/bin/${{ matrix.fortran-compiler }}
              fi
            fi
            sudo apt-get clean
          elif [ "$RUNNER_OS" == "macOS" ]; then
            brew install --formula --quiet ${{ matrix.compiler-install }} parallel ${{ matrix.hdf5-install }}
            if [[ ${{ matrix.compiler-type }} == 'GNU' || ${{ matrix.compiler-type }} == 'CLANG' ]]; then
              if [[ ${{ matrix.compiler-type }} == 'GNU' ]]; then
                sudo ln -Fs $BREW_COMPILER_PREFIX/${{ matrix.c-compiler }}-${{ matrix.compiler-version }} \
                  $BREW_COMPILER_PREFIX/${{ matrix.c-compiler }}
                sudo ln -Fs $BREW_COMPILER_PREFIX/${{ matrix.cxx-compiler }}-${{ matrix.compiler-version }} \
                  $BREW_COMPILER_PREFIX/${{ matrix.cxx-compiler }}
                sudo ln -Fs $BREW_COMPILER_PREFIX/${{ matrix.fortran-compiler }}-${{ matrix.compiler-version }} \
                  $BREW_COMPILER_PREFIX/${{ matrix.fortran-compiler }}
              elif [[ ${{ matrix.compiler-type }} == 'CLANG' ]]; then
                sudo ln -Fs $BREW_COMPILER_PREFIX/${{ matrix.fortran-compiler }}-${{ matrix.fortran-compiler-version }} \
                  $BREW_COMPILER_PREFIX/${{ matrix.fortran-compiler }}
              fi
            fi
          fi
      - name: 'Log Softare Environment Configuration'
        run: |
          if [ "$RUNNER_OS" == "Linux" ]; then
            if [ ${{ matrix.compiler-type }} == 'INTELLLVM' ]; then
              source /opt/intel/oneapi/setvars.sh
            fi
            echo "OS version:"
            cat /etc/os-release
            echo
            echo "Kernel version:"
            uname -a
            echo
            ldd --version
            echo
            echo "Fortran compiler version:"
            ${{ matrix.fortran-compiler }} --version
            echo
            if [ ${{ matrix.compiler-type }} == 'INTELLLVM' ]; then
              echo "MKL install directory:"
              echo "${MKLROOT}"
              echo
            fi
            echo "CMake version:"
            cmake --version
            echo
            echo "GNU Parallel version:"
            parallel --version
          elif [ "$RUNNER_OS" == "macOS" ]; then
            echo "OS version:"
            cat /System/Library/CoreServices/SystemVersion.plist
            echo
            echo "Kernel version:"
            uname -a
            echo
            echo "Fortran compiler version:"
            ${{ matrix.fortran-compiler }} --version
            echo
            echo "CMake version:"
            cmake --version
            echo
            echo "GNU Parallel version:"
            parallel --version
          fi
      - name: 'Configure Serial Version'
        run: |
          mkdir build
          cd build
          if [ ${{ matrix.compiler-type }} == 'INTELLLVM' ]; then
            source /opt/intel/oneapi/setvars.sh
            cmake .. -DCOMPILER=${{ matrix.compiler-type }} \
              -DENABLEF=TRUE -DHDF5=${{ matrix.hdf5-restart-support }} \
              -DCMAKE_INSTALL_PREFIX=$PWD/../install \
              -DMKL_HOME=$MKLROOT -DMKL_MULTI_THREADED=FALSE -DTRUST_SYSTEM_LIBS=TRUE
          else
            cmake .. -DCOMPILER=${{ matrix.compiler-type }} \
              -DENABLEF=TRUE -DHDF5=${{ matrix.hdf5-restart-support }} \
              -DCMAKE_INSTALL_PREFIX=$PWD/../install
          fi
      - name: 'Build and Install Serial Version Using 2 Jobs'
        run: |
          if [ ${{ matrix.compiler-type }} == 'INTELLLVM' ]; then
            source /opt/intel/oneapi/setvars.sh
          fi
          cd build
          cmake --build . --parallel 2 --verbose
          cmake --install .
      - name: 'Run Tests for Serial Version'
        run: |
          if [ ${{ matrix.compiler-type }} == 'INTELLLVM' ]; then
            source /opt/intel/oneapi/setvars.sh
          fi
          cd install
          ./runtest --serial --full
      - name: 'Upload Test Artifacts for Serial Version'
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: serial-cmake-tests-${{ matrix.os }}-${{ matrix.compiler-type }}-${{ matrix.compiler-version }}
          path: |
            ${{ github.workspace }}/install/runtest.log
            ${{ github.workspace }}/install/runtest-verbose.log
            ${{ github.workspace }}/install/test/runs/serial
          retention-days: 3
          compression-level: 6
      - name: 'Download Test Artifacts for Serial Version'
        uses: actions/download-artifact@v4
        with:
          name: serial-cmake-tests-${{ matrix.os }}-${{ matrix.compiler-type }}-${{ matrix.compiler-version }}
      - name: 'Display Artifacts'
        run: |
          ls -R
